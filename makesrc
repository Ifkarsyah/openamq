#
#  Make full source package
#
VERSION=`egrep "  version" project.pdl | cut -d\" -f2`
CVSTAG=OpenAMQ_`echo $VERSION | sed 's/\./_/'`
PACKAGE=openamq-$VERSION-src
echo "Building $PACKAGE..."

#  CVS tag current version
cvs tag -RF $CVSTAG

echo "Preparing base..."
cd $HOME/products/base
rm -f *.tar.gz
boom
boom distsrc >/dev/null 2>&1

echo "Preparing base2..."
cd $HOME/products/base2
rm -f *.tar.gz
boom
boom distsrc >/dev/null 2>&1

echo "Preparing openamq..."
cd $HOME/products/openamq
rm -f *.tar.gz
boom
boom distsrc >/dev/null 2>&1

rm -rf openamq-$VERSION
mkdir  openamq-$VERSION
cd     openamq-$VERSION

mkdir base
cd    base
tar -xzf $HOME/products/base/*.tar.gz
cd ..

mkdir base2
cd    base2
tar -xzf $HOME/products/base2/*.tar.gz
cd ..

mkdir openamq
cd    openamq
tar -xzf $HOME/products/openamq/*.tar.gz
cd ..

echo "#  We build & install these 3 products..." > build.sh
echo "cd base;    sh build.sh; cd .."           >> build.sh
echo "cd base2;   sh build.sh; cd .."           >> build.sh
echo "cd openamq; sh build.sh; cd .."           >> build.sh
echo "echo Server is installed into openamq-server" >> build.sh

#   Force foreign products to reconfigure at build time
rm base2/foreign/apr-*/Makefile
rm base2/foreign/db-*/build_unix/Makefile

cd ..
echo "Building OpenAMQ/$VERSION packages..."
zip -lqr $PACKAGE.zip    openamq-$VERSION
tar -czf $PACKAGE.tar.gz openamq-$VERSION

echo cd pub>response
echo bin>>response
echo put $PACKAGE.zip>>response
echo put $PACKAGE.tar.gz>>response
echo quit>>response
ftp openamq.org < response
rm response
echo "Unix source is at: http://openamq.org/pub/$PACKAGE.zip"
echo "Win32 source is at: http://openamq.org/pub/$PACKAGE.tar.gz"
