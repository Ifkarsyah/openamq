<?xml?>
<!-- Script to test the Rest class implementation -->
<!-- restapi.icl depends on these tests working -->

<pal script = "amq_pal_gen">
    <session>
        <!-- Check all valid types -->
        <invoke macro = "feed crud">
            <set name = "test_class" value = "fanout" />
        </invoke>
        <invoke macro = "feed crud">
            <set name = "test_class" value = "direct" />
        </invoke>
        <invoke macro = "feed crud">
            <set name = "test_class" value = "topic" />
        </invoke>
        <invoke macro = "feed crud">
            <set name = "test_class" value = "headers" />
        </invoke>
        <invoke macro = "feed crud">
            <set name = "test_class" value = "rotator" />
        </invoke>
        <invoke macro = "feed crud">
            <set name = "test_class" value = "service" />
        </invoke>

        <!-- Test access to pre-declared feeds -->
        <restms_feed_create feed_name = "amq.direct" class_name = "direct" />
        <assert name = "response" value = "0">$reply_text</assert>
        <restms_feed_create feed_name = "amq.direct" class_name = "topic" />
        <assert name = "response" value = "1">$reply_text</assert>
        <restms_feed_query feed_name = "amq.direct" />
        <assert name = "response" value = "0">$reply_text</assert>
        <restms_feed_delete feed_name = "amq.direct" />
        <assert name = "response" value = "1">$reply_text</assert>

        <!-- Test invalid accesses -->
        <restms_feed_create feed_name = "amq.reserved" class_name = "direct" />
        <assert name = "response" value = "1">$reply_text</assert>
        <restms_feed_create feed_name = "test.invalid" class_name = "invalid" />
        <assert name = "response" value = "1">$reply_text</assert>
        <restms_feed_create feed_name = "test.null" class_name = "" />
        <assert name = "response" value = "1">$reply_text</assert>
        <restms_feed_delete feed_name = "$\\default$\\" />
        <assert name = "response" value = "1">$reply_text</assert>
        <restms_feed_query feed_name = "" />
        <assert name = "response" value = "1">$reply_text</assert>

        <echo>Rest class tests passed successfully</echo>
    </session>

    <!-- Macro does set of tests for one valid feed type -->
    <macro name = "feed crud">
        <!-- Create the feed and check the create worked -->
        <restms_feed_create feed_name = "test.$test_class" class_name = "$test_class" />
        <assert name = "response" value = "0">$reply_text</assert>

        <!-- Test that query works -->
        <restms_feed_query feed_name = "test.$test_class" />
        <assert name = "response" value = "0">$reply_text</assert>
        <restms_feed_query feed_name = "test.$test_class.bogus" />
        <assert name = "response" value = "1">$reply_text</assert>

        <!-- Test that update works when the type is correct -->
        <restms_feed_create feed_name = "test.$test_class" class_name = "$test_class" />
        <assert name = "response" value = "0">$reply_text</assert>
        <restms_feed_create feed_name = "test.$test_class" class_name = "invalid" />
        <assert name = "response" value = "1">$reply_text</assert>

        <!-- Test query on class -->
        <restms_feed_class_query class_name = "$test_class" />
        <assert name = "response" value = "0">$reply_text</assert>

        <!-- Now delete the feed, and again a second time -->
        <restms_feed_delete feed_name = "test.$test_class" />
        <assert name = "response" value = "0">$reply_text</assert>
        <restms_feed_delete feed_name = "test.$test_class" />
        <assert name = "response" value = "0">$reply_text</assert>
    </macro>
</pal>
