<?xml?>
<pal script = "amq_pal_gen">
    <session>
        <set name = "count" value = "1000" cmdline = "C" />
        <set name = "subscribers" value = "1" cmdline = "S" />
	<exchange_declare exchange = "stoptopic" type = "direct" />
	<queue_declare queue = "stopqueue" />
	<queue_bind queue = "stopqueue" exchange = "stoptopic" />
	<timer />
        <repeat times = "$count" counter = "counter">
	    <basic_content message_id = "id-$counter" routing_key = "foo.bar.baz.$counter" />
	    <basic_publish exchange = "mytopicexchange" routing_key = "foo.bar.baz.$counter"/>
        </repeat>
	<basic_consume queue = "stopqueue" />
	<set name = "stopcount" value = "0" />
	<repeat>
		<wait/>
		<basic_arrived>
			<inc name = "stopcount" />
			<echo>got stop message</echo>
		</basic_arrived>
		<empty>
			<echo>empty</echo>
		</empty>
		<if name = "stopcount" test = "eq" value = "$subscribers">
			<timer action = "show" />
			<exit />
		</if>
	</repeat>
    </session>
    
</pal>


