<?xml?>
<pal
    script = "amq_pal_gen"
    desc   = "Subscribe client 2"
    >
    <set name = "count" value = "1000" cmdline = "C" />
    <set name = "client" value = "0" cmdline = "N" />
    <session>
        <exchange_declare exchange = "myheadersexchange" type = "headers" />
        <queue_declare queue = "myheaderqueue-$client" />
        <queue_bind queue = "myheaderqueue-$client" exchange = "myheadersexchange">
            <arguments>
                <field name = "x" value = "a" />
            </arguments>
        </queue_bind>
        <basic_consume queue = "myheaderqueue-$client" />
        <set name = "total" value = "0" />
        <repeat>
            <wait />
            <if  name  = "total" value = "0" >
                <timer />
            </if>
            <basic_arrived>
                <inc name = "total" />
                <!-- <echo>In $messages: [$message_id] with x=$headers-x y=$headers-y z=$headers-z</echo>-->
            </basic_arrived>
            <empty>
                <abort>No message</abort>
            </empty>
	    <!-- <echo>count: $count total: $total</echo> -->
            <if name = "count" test = "eq" value = "total">
                <timer action = "show" />
		<basic_content message_id="stopmessage" />
		<basic_publish exchange = "stopheaders" />
                <exit />
            </if>
        </repeat>
    </session>
    
</pal>


