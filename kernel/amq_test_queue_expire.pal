<?xml?>
<pal script = "amq_pal_gen">
<!-- This tests that a deleted queue really goes away -->

<!-- Don't use own variables with the same name as standard variables -->
<set name = "myqueue" value = "my.test" />
<macro name = "check queue">
    <basic_get />
    <basic_arrived>
        <echo>Arrived: $message_id</echo>
    </basic_arrived>
    <basic_bounced>
        <echo>Bounced: $message_id</echo>
    </basic_bounced>
</macro>

<session
    exchange  = "amq.direct"
    queue     = "$myqueue"
    error_handling = "recover">

    <basic_content message_id = "should-bounce-before" />
    <basic_publish routing_key = "$myqueue" mandatory = "1" />
    <invoke macro = "check queue" />

    <queue_declare />
    <queue_bind>
        <arguments>
            <field name = "routing_key" value = "$myqueue" />
        </arguments>
    </queue_bind>
    <basic_content message_id = "should-arrive" />
    <basic_publish routing_key = "$myqueue" mandatory = "1" />
    <invoke macro = "check queue" />

    <queue_delete />
    <basic_content message_id = "should-bounce-after" />
    <basic_publish routing_key = "$myqueue" mandatory = "1" />
    <invoke macro = "check queue" />
</session>

</pal>
