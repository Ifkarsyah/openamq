<?xml?>
<!--
    Simple test for queue purge
    This test publishes a few messages to a queue, gets those, then the queue is purged.
        Finally, we try to receive messages but we should not receive any.
  -->
<pal script = "amq_pal_gen">
    <session>
        <echo>TEST: queue_purge_simple</echo>
        <queue_declare queue = ""/>
        <queue_bind queue = "$queue" exchange = "amq.direct" routing_key = "a_dest"/>
        <!-- Publish 5 messages -->
        <echo>I: Publishing 5 messages</echo>
        <invoke macro = "publish">
            <set name = "messages" value = "5"/>
        </invoke>
        <!-- Get them -->
        <echo>I: Browsing</echo>
        <invoke macro = "get">
            <set name = "messages" value = "5"/>
            <set name = "queue" value = "$queue"/>
        </invoke>
        <invoke macro = "receive">
            <set name = "messages" value = "5"/>
        </invoke>
        <echo>I: Purging</echo>
        <!-- Purge queue -->
        <queue_purge queue = "$queue" />
        <!-- Consume messages -->
        <echo>I: Trying to consume</echo>
        <basic_consume queue = "$queue" />
        <invoke macro = "receive">
            <set name = "messages" value = "0"/>
        </invoke>
    </session>

    <macro name = "publish">
        <set name = "count" value = "0" />
        <repeat times = "$messages">
            <basic_content size = "1024" message_id = "id-$count"/>
            <basic_publish exchange = "amq.direct" routing_key = "a_dest" />
            <inc name = "count"/>
        </repeat>
    </macro>

    <macro name = "get">
        <repeat times = "$messages">
            <basic_get queue = "$queue"/>
        </repeat>
    </macro>

    <macro name = "receive">
        <set name = "count" value = "0"/>
        <wait timeout = "1000"/>
        <basic_arrived>
            <echo>I: Message arrived: $message_id</echo>
            <inc name = "count"/>
        </basic_arrived>
        <empty>
            <echo>I: Message count: $count</echo>
        </empty>
        <echo>I: Message count: $count</echo>
        <assert name = "count" value = "$messages">E: Expecting $messages messages, got $count</assert>
    </macro>

    <echo>PASS: queue_purge_simple</echo>
</pal>
